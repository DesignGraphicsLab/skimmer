<!DOCTYPE html>
<html>
<head>

<meta charset="ISO-8859-1">
<title>Skimmer</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Skimmer</title>
		<script type="text/javascript" src="js/skimmer.js"></script>
		<script type="text/javascript" src="js/stopwords.js"></script>
		<script type="text/javascript" src="lib/jquery/jquery-1.3.2.js"></script>
		<script type="text/javascript" src="js/agent.js"></script>
		<script type="text/javascript" src="js/obj_vet.js"></script>
		<script type="text/javascript" src="js/article.js"></script>
		<script type="text/javascript" src="js/map.js"></script>
		<script type="text/javascript" src="js/stemmer.js"></script>
		<script type="text/javascript" src="js/dictionary.js"></script>
		
		<script type="text/javascript" src="js/invertedFileSystem.js"></script>
		
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type = "text/javascript">
	var skimmer;
	var canvas;
	var ctx;
	var intervalID;

	var feedFinished = 0;		// A flag used to denote the end of feeding and is initially set zero
	var feedResult;				// The result of using google feed API

	var numEntries = 20;		// The number of entries to be obtained in the feed result
	
	// Default RSS source address
	var sourceAddress = "http://calendar.activedatax.com/ncstate/RSSSyndicator.aspx?category=&location=&type=N&binary=Y&keywords=";
	//var ratioCanvas = 18.0/20;
	var ratioCanvas = 1;
	var scaleNow = 0;
	var scaleOld = 0;
	var isFlickr = 0;
	var currentCursor = new Vector2();
	var linkFlag = 0;
	var showImageFlag = 1;
	var checkImageUrlFlag = 0;
	var depthOrder = new Array();
	var depthChangeCount = 0 ;
	var DEPTHLAYER = 5;
	var LEAST_IMAGE_WIDTH = 10;
	var AGENT_REMOVE_LIMIT = 50;
	// Define the inverted file system
	//var IFS = new InvertedFileSystem();
	
	// Read RSS from a website with the help of Google Javascript API Google Feed
	google.load("feeds", "1");
	// Define the callback function
	function initialize() {
	
		// Reset the feeding flag
		feedFinished = 0;
		
		// Set the URL for the google feed API
		var feed = new google.feeds.Feed(sourceAddress);
		// Set the number of entries to be read from the RSS online
		feed.setNumEntries(numEntries);

		// downloads the feed specified in the constructor from Google's servers and calls the given callback when the download completes
		feed.load(function(result) {
			if (!result.error) {
				feedResult = result;
				canvas = document.getElementById("canvas");
				
				// Initialize the absolute position to zero
				absPosX = 0;
				absPosY = 0;
				
				tempElem = canvas;
				
				while (tempElem.offsetParent != null) {
					absPosX += tempElem.offsetLeft;
					absPosY += tempElem.offsetTop;
					tempElem = tempElem.offsetParent;
				}

				// Finally get the absolute position of the canvas element
				absPosX += tempElem.offsetLeft;
				absPosY += tempElem.offsetTop;


				
				// Build the skimmer and set the attributes for the skimmer
				skimmer = new Skimmer(absPosX, absPosY, canvas.width, canvas.height, feedResult, numEntries);
				skimmer.addNewArticles();
				skimmer.extractArticleMinMax();
				skimmer.checkForAdjacencies();
				skimmer.updateAgents();
				skimmer.extractAgentMinMax();
				var selectObj = document.getElementById("selectColor");
				var selectIndex=selectObj.selectedIndex;
				var selectVal = selectObj.options[selectIndex].value;
				skimmer.colorType = selectVal;
				skimmer.updateAgentColor();

				// Hide the progress bar when feeding is done
			}

			feedFinished = 1;

		});
	}
	google.setOnLoadCallback(initialize);


	// Set the event when a key is pressed
	function keyDown(event){
		 var keyCode = ('which' in event) ? event.which : event.keyCode;
		 if(keyCode == 27){
			 if(skimmer.agentArticle != null){
				 skimmer.agentArticle.remove = true;
				 skimmer.selectedWords.length = 0;
				 skimmer.selectedArticles.length = 0;
				 skimmer.selectedArticleRanking.clear();
			 }
			 else if(skimmer.zoomedAgents.length > 0){
				 for(var i = 0 ; i < skimmer.zoomedAgents.length; i++){
					 skimmer.zoomedAgents[i].remove = true;
				 }
				 skimmer.zoomedAgents.length = 0;
			 }
			 else{
				 clearInterval(intervalID);
			 }
		 }else if(keyCode == 49){
			 skimmer.colorType = 0;
			 skimmer.updateAgentColor();
		 }else if(keyCode == 50){
			 skimmer.colorType = 1;
			 skimmer.updateAgentColor();
		 }else if(keyCode == 51){
			 skimmer.colorType = 2;
			 skimmer.updateAgentColor();
		 }else if(keyCode == 52){
			 skimmer.colorType = 3;
			 skimmer.updateAgentColor();
		 }else if(keyCode == 13){
			// Set the action when the "Enter" button is pressed down
			document.getElementById("skimmerSearching").click();
		 }
	}
	
	
	var mouseMoveFlag = 0;
	var isControlPanelHide = false;
	var mouseMoveIntervalID;
	
	
	var recordeClientMouseCoorX = 0;
	var recordeClientMouseCoorY = 0;
	
	function mouseMove(event){
	
		//mouseMoveFlag = 0;
		
		if( skimmer != undefined ) {
			
			currentCursor.set(event.clientX - skimmer.left , event.clientY - skimmer.top);
			//console.log(currentCursor);
			
			
			// The last position of the cursor is recorded to check mouse move
			// These code are added because of the bug in Chrome browsers
			if ((event.clientX != recordeClientMouseCoorX) && (event.clientY != recordeClientMouseCoorY)) {

				if (isControlPanelHide == true) {
				}

				mouseMoveFlag = 0;

				recordeClientMouseCoorX = event.clientX;
				recordeClientMouseCoorY = event.clientY;
			}
			
		}
		else {
			mouseMoveFlag = 0;
		}
	}
	
	function hideControlPanel(status) {
		if (status == "hide") {
			// Hide the control panel

			var winWidth = getWinWidth();
			var winHeight = getWinHeight();

			table = document.getElementById("overallFrame");
			table.style.display = winWidth*ratioCanvas;
			table.height = winHeight*ratioCanvas;

			tableSel = document.getElementById("selectFrame");
			tableSel.hidden = true;
			
			canvas = document.getElementById("canvas");
			canvas.width = table.width;
			canvas.height = table.height;
			
			ctx = canvas.getContext("2d");

			// Get the style ratio of the elements on the webpage
			if (canvas.width <= canvas.height) {
				scaleNow = canvas.width;
				scaleOld = 1024;
			}
			else {
				scaleNow = canvas.height;
				scaleOld = 768;
			}
			
			isControlPanelHide = true;
		}
		else {
			// Show the control panel
			var winWidth = getWinWidth();
			var winHeight = getWinHeight();

			table = document.getElementById("overallFrame");
			table.style.display = winWidth*ratioCanvas;
			table.height = winHeight*ratioCanvas;

			tableSel = document.getElementById("selectFrame");
			tableSel.hidden = false;
			
			canvas = document.getElementById("canvas");
			canvas.width = Math.round(table.width * 8.0 / 9);
			canvas.height = table.height;
			
			ctx = canvas.getContext("2d");

			// Get the style ratio of the elements on the webpage
			if (canvas.width <= canvas.height) {
				scaleNow = canvas.width;
				scaleOld = 1024;
			}
			else {
				scaleNow = canvas.height;
				scaleOld = 768;
			}

			isControlPanelHide = false;
			mouseMoveFlag = 0;
		}

		skimmer.width = canvas.width;
		skimmer.height = canvas.height;
		if(skimmer.agentArticle!=null) {
			skimmer.agentArticle.width = skimmer.width / 3 * scaleNow / scaleOld;

			skimmer.agentArticle.height = skimmer.height / 3 * scaleNow / scaleOld;
		}
		
		absPosX = 0;
		absPosY = 0;
		
		tempElem = canvas;
		
		while (tempElem.offsetParent != null) {
			absPosX += tempElem.offsetLeft;
			absPosY += tempElem.offsetTop;
			tempElem = tempElem.offsetParent;
		}
		
		absPosX += tempElem.offsetLeft;
		absPosY += tempElem.offsetTop;
		
		skimmer.left = absPosX;
		skimmer.top = absPosY;

	}

	// Check whether the mouse is moving
	function checkMouseMove() {
		// Count up the time during which the mouse did not move
		if (skimmer != undefined) {
			if ((isControlPanelHide == false)&&(mouseMoveFlag >= 10)) {
				hideControlPanel("hide");
			}
			else if ((isControlPanelHide == true)&&(mouseMoveFlag < 10)) {
				hideControlPanel("show");
			}
			mouseMoveFlag++;
		}
	}
	
	function checkImageUrl(){
	
		for(var i =0 ; i<skimmer.agents.length ; i++){
			var count = skimmer.agents[i].imageLinkList.length;
				var k=0;
				for(var j=0; j<count ; j++){
				var tmp = new Image();
				tmp.src = skimmer.agents[i].imageLinkList[k];
				if(tmp.width>0){k++;}
				else
				{
					//alert(skimmer.agents[i].imageLinkList[k]);
					skimmer.agents[i].imageLinkList[k]=skimmer.agents[i].imageLinkList[skimmer.agents[i].imageLinkList.length-1];
					skimmer.agents[i].imageLinkList.pop();
				}
				
			}
		
		}
	}
	

	function buildAgentLinkList(){
		
		for(var i = 0; i < skimmer.agents.length; i++){
		console.log(i+" "+skimmer.agents[i].text);
			for(var j = 0; j < skimmer.articles.length; j++){
				if(skimmer.articles[j].words.indexOf(skimmer.agents[i].text) > -1 || skimmer.articles[j].titlewords.indexOf(skimmer.agents[i].text)  > -1 ){
					if(skimmer.articles[j].imageUrl != null){
						
						skimmer.agents[i].imageLinkList.push(skimmer.articles[j].imageUrl);
						
					
					}
				}
			}		
		}
		
		for(var i = 0; i < skimmer.agents.length; i++){
			depthOrder[i]=new Array();
			depthOrder[i][0]=depthOrder[i][1]=i;
		}
		//alert("skimmer.agents.length  "+skimmer.agents.length)
		//alert("depthOrder.length "+depthOrder.length);
		//alert("oj");
	
	}
	

	function mouseClick(event){
		var cursor = new Vector2();
		cursor.set(event.clientX - skimmer.left - (skimmer.width / 2), event.clientY - skimmer.top - (skimmer.height / 2 ));
		
		if(event.button == 0 && linkFlag == 2)
		{
			window.open('http://designgraphics.ncsu.edu/search/label/skimmer');
		}
		else if(event.button == 0 && linkFlag == 3 )
		{
			window.open('http://designgraphics.ncsu.edu');
		}
		
		
		if(skimmer.agentArticle!=null){
			var agentArticleBounds = skimmer.agentArticle.getBoundingBox();
			if(agentArticleBounds.contains(cursor)){
				var curIndex = skimmer.selectedArticles.indexOf(skimmer.selectedArticle);
				if(curIndex >= 0){
					if(event.button == 0){
						//if(agentArticleBounds.containsLink(cursor))
						if (linkFlag == 1)
						{
							window.open(skimmer.agentArticle.source);
						}
						
						else
						{
							curIndex += 1;
						}
					}
					else{
						curIndex -= 1;
					}
					if(curIndex >= skimmer.selectedArticles.length){
						curIndex = 0;
					}
					if(curIndex < 0){
						curIndex = skimmer.selectedArticles.length - 1;
					}
					skimmer.selectedArticle = skimmer.selectedArticles[curIndex];
					skimmer.agentArticle.title = skimmer.selectedArticle.title;
					skimmer.agentArticle.text = skimmer.selectedArticle.summary;
					skimmer.agentArticle.source = skimmer.selectedArticle.source;
					//if( isFlickr == 1 )
					//skimmer.agentArticle.imageUrl = convertUrl(skimmer.selectedArticle.imageUrl);
					//else
					skimmer.agentArticle.imageUrl = skimmer.selectedArticle.imageUrl;
				}
			}
			else{
				skimmer.agentArticle.remove = true;
				skimmer.selectedWords.length = 0;
				skimmer.selectedArticles.length = 0;
				skimmer.selectedArticleRanking.clear();
			}
		}
		if(event.button == 0 && event.shiftKey == true && event.ctrlKey == false && event.altKey == false){
			
			skimmer.selectedWords.length = 0;
			skimmer.selectedArticles.length = 0;
			skimmer.selectedArticleRanking.clear();
			
			// Build the selected words list
			var tmpVect = new Vector2();
			var dist;
			for(var i = 0; i < skimmer.agents.length; i++){
				var agent = skimmer.agents[i];
				
				tmpVect.setVect(agent.pos);
				tmpVect.sub(cursor);

				dist = tmp = tmpVect.length();
				if(dist < agent.radius){
					skimmer.selectedWords.push(agent);
				}
			}
			
			// If words were selected, rank articles based on the selected articles
			// Then sort them into a list of the top picks
			// Finally generate the agent
			if(skimmer.selectedWords.length > 0){
				for(var i = 0; i < skimmer.articles.length; i++){
					var article = skimmer.articles[i];
					var rank = 0;
					for(var j = 0; j < skimmer.selectedWords.length; j++){
						var agent = skimmer.selectedWords[j];
						if(article.words.indexOf(agent.stem) > -1){
							rank += 1.0 + (agent.occurrences / skimmer.maxOccurrence);
						}
						if(article.titlewords.indexOf(agent.stem) > -1){
							rank += 2.0;
						}
					}
					skimmer.selectedArticleRanking.put(article,rank);
		
				}
				
				// Build a collection of the top ranked articles
				for(var i = 0; i < skimmer.selectedArticleRanking.valSet().length; i++){
					var article = skimmer.selectedArticleRanking.keySet()[i];
					var rank = skimmer.selectedArticleRanking.valSet()[i];
					
					if(skimmer.selectedArticles.length == 0){
						skimmer.selectedArticles.push(article);
					}
					else{
						for(var j = 0; j < skimmer.selectedArticles.length; j++){
							var curArticle = skimmer.selectedArticles[j];
							var curRank = skimmer.selectedArticleRanking.get(curArticle);
							
							if(rank >= curRank){
								skimmer.selectedArticles = skimmer.selectedArticles.add(article, j);
								break;
							}
							
						}
						if(skimmer.selectedArticles.indexOf(article) < 0){
							skimmer.selectedArticles.push(article);
						}
					}
				}
				
				if(skimmer.selectedArticles.length != 0){
					skimmer.selectedArticle = skimmer.selectedArticles[0];
					
					//alert("scaleNow" + scaleNow +"scaleOld" + scaleOld);
					//if( isFlickr == 1 )
					//skimmer.agentArticle = new AgentArticle(skimmer.width / 3 * scaleNow / scaleOld, skimmer.height / 3 * scaleNow / scaleOld, skimmer.selectedArticle.title, skimmer.selectedArticle.summary, skimmer.selectedArticle.source,convertUrl(skimmer.selectedArticle.imageUrl));
					//else
					skimmer.agentArticle = new AgentArticle(skimmer.width / 3 * scaleNow / scaleOld, skimmer.height / 3 * scaleNow / scaleOld, skimmer.selectedArticle.title, skimmer.selectedArticle.summary, skimmer.selectedArticle.source,skimmer.selectedArticle.imageUrl);
					//fix color
					//alert(skimmer.width / 3 * scaleNow / scaleOld+"  "+skimmer.height / 3 * scaleNow / scaleOld)
					skimmer.agentArticle.pos.setVect(cursor);
				}
				
			}
			
			
			
			//var showNews = document.getElementById("NewsDetail");
			//showNews.appendChild(document.createTextNode(skimmer.selectedArticles[0].rsscontent));

			
		}
		else if(event.button == 0 && event.shiftKey == false && event.ctrlKey == true && event.altKey == false){
			var clickedAgent = skimmer.getAgentClickedAt(cursor);
			//console.log(cursor.toString());
			if(clickedAgent != null && clickedAgent.clickPriority == 1){
				// Build a collection of the top ranked words for entry
				var newWords = new Array();
				var clickedWord = clickedAgent.stem;
				
				for(var i = 0; i < skimmer.words.length; i++){
					var word = skimmer.words[i];
					var alreadyAnAgent = false;
					for(var j = 0; j < skimmer.agents.length; j++){
						var agent = skimmer.agents[j];
						if(word.toLowerCase() == agent.stem.toLowerCase()){
							alreadyAnAgent = true;
							break;
						}
					}
					if(!alreadyAnAgent){
						var pair = skimmer.getPair(clickedWord, word);
						var cooccurrence = skimmer.cooccurrences.get(pair);
						var cfidf = cooccurrence / skimmer.occurrences.get(word);
						
						if(newWords.length == 0){
							newWords.push(word);
						}
						else if(newWords.length < skimmer.MAX_WORDS_PER_ZOOM){
							for(var j = 0; j < newWords.length; j++){
								var curWord = newWords[j];
								var curPair = skimmer.getPair(clickedWord, curWord);
								var curCooccurrence = skimmer.cooccurrences.get(curPair);
								var curCfidf = curCooccurrence / skimmer.occurrences.get(curWord);
								
								if(cfidf >= curCfidf){
									newWords = newWords.add(word, j);
									break;
								}
								
							}
							if(newWords.indexOf(word) < 0){
								newWords.add(word);
							}
						}
						else{
							var lastWord = newWords[newWords.length - 1];
							var lastPair = skimmer.getPair(clickedWord, lastWord);
							var lastCooccurrence = skimmer.cooccurrences.get(lastPair);
							var lastCfidf = lastCooccurrence / skimmer.occurrences.get(lastWord);
							
							if(cfidf > lastCfidf){
								newWords.pop();
								for(var j = 0; j < newWords.length; j++){
									var curWord = newWords[j];
									var curPair = skimmer.getPair(clickedWord, curWord);
									var curCooccurrence = skimmer.cooccurrences.get(curPair);
									var curCfidf = curCooccurrence / skimmer.occurrences.get(curWord);
									
									if(cfidf >= curCfidf){
										newWords = newWords.add(word, j);
										break;
									}
								}
								if(newWords.indexOf(word) < 0){
									newWords.push(word);
								}
							}
						}
					}
				}
				
				var tmpAgent;
				for(var i = 0; i < newWords.length; i++){
					var word = newWords[i];
					if(skimmer.zoomedAgents.length > skimmer.MAX_ZOOMED_AGENTS){
						skimmer.zoomedAgents.shift().remove = true;
					}
					tmpAgent = new AgentWord();
					
					tmpAgent.stem = word;
					tmpAgent.text = skimmer.stems.get(word);
					tmpAgent.occurrences = skimmer.occurrences.get(word);
					tmpAgent.pos.set(cursor.x - 3.0 + Math.random() * 6.0, cursor.y - 3.0 + Math.random() * 6.0);
					tmpAgent.avgPos.setVect(tmpAgent.pos);
					tmpAgent.timestamp = new Date();
					tmpAgent.desiredAlpha = 1.0;
					tmpAgent.textColor = skimmer.colorAgentWordText;
					
					//color
					tmpAgent.clickPriority = 2;
					skimmer.agents.push(tmpAgent);
					skimmer.zoomedAgents.push(tmpAgent);
				}
				skimmer.updateAgentColor();
				
			}
			
			buildAgentLinkList();
		}
		else if(event.button == 0 && event.shiftKey == true && event.ctrlKey == true && event.altKey == true){
			
			var clickedAgent = skimmer.getAgentClickedAt(cursor);
			if(clickedAgent != null){
				var curIndex = skimmer.agents.indexOf(clickedAgent);
				skimmer.agents[curIndex].remove = true;
			}
		}
	}
	
	
	function drawAvoidStretch(agent,ctx, img, color,dx, dy, dw, dh){
		
		var minLength = img.width>img.height?img.height:img.width;
		
		var stretchFactor = 1;
		if (minLength < LEAST_IMAGE_WIDTH)
		{
		}
		else if ( minLength * 1.0 / dw > stretchFactor )   
		//center
		{
			ctx.save();
			ctx.beginPath();
			ctx.arc(dx+dw*0.5,dy+dh*0.5,dw*0.5,0,2*Math.PI,true);
			ctx.closePath();
			ctx.clip();
			//ctx.save();
				//ctx.beginPath();
				//ctx.arc(Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y),Math.round(radius/2),0,Math.PI*2,true);
				//ctx.closePath();
				//ctx.clip();
			
			
			
			if(img.width>img.height){
				ctx.drawImage(img,0.5*(img.width-img.height),0,img.height,img.height, dx, dy, dw, dh);
			}
			else{
				ctx.drawImage(img,0, 0.5*(img.height-img.width),img.width,img.width, dx, dy, dw, dh);
			}
			if(skimmer.selectedWords.length != 0 && (skimmer.selectedWords.indexOf(agent) < 0 ))
			{
			ctx.fillStyle= 'rgba(100,100,100,0.5)';
			ctx.fillRect(dx,dy,dw,dh);
			}
			ctx.restore();
		}
		else       
		//fade with color
		{
			
			ctx.save();
			
			ctx.beginPath();
			ctx.arc(dx+dw*0.5,dy+dh*0.5,minLength/ stretchFactor*0.5, 0,Math.PI*2,true);
			//ctx.arc(dx+dw*0.5,dy+dh*0.5,dw, 0,Math.PI*2,true);
			ctx.closePath();
			ctx.clip();
			
			//ctx.drawImage(img,dx,dy,dw,dh);
			
			
			
			if(img.width>img.height){
				ctx.drawImage(img,0.5*(img.width-img.height),0,img.height,img.height,dx+dw*0.5-minLength*0.5 / stretchFactor,dy+dh*0.5-minLength*0.5/ stretchFactor,minLength/ stretchFactor,minLength/ stretchFactor );
			}
			else{
				ctx.drawImage(img,0, 0.5*(img.height-img.width),img.width,img.width,dx+dw*0.5-minLength*0.5/ stretchFactor,dy+dh*0.5-minLength*0.5/ stretchFactor,minLength/ stretchFactor,minLength/ stretchFactor);
			}
			if(skimmer.selectedWords.length != 0 && (skimmer.selectedWords.indexOf(agent) < 0 ))
			{
			ctx.fillStyle= 'rgba(100,100,100,0.5)';
			ctx.fillRect(dx,dy,dw,dh);
			}
			
			ctx.restore();
			
			ctx.save();
			ctx.beginPath();
			ctx.arc(dx+dw*0.5,dy+dh*0.5,dw*0.5,0,2*Math.PI,true);
			ctx.closePath();
			ctx.clip();
			var radgrad = ctx.createRadialGradient(dx+dw*0.5,dy+dh*0.5,minLength/stretchFactor*0.5*0.7,dx+dw*0.5,dy+dh*0.5,dw);
			//var radgrad = ctx.createRadialGradient(dx+dw*0.5,dy+dh*0.5,0,dx+dw*0.5,dy+dh*0.5,dw);
			var tmpAlpha = color.alpha;
			color.alpha = 0;
			radgrad.addColorStop(0,color);
			color.alpha = tmpAlpha;
			radgrad.addColorStop((minLength/stretchFactor*0.5*0.3/(dw-minLength/stretchFactor*0.5*0.7)),color);
			ctx.fillStyle = radgrad;
			ctx.fillRect(dx,dy,dw,dh);
			ctx.restore();
			
			
			
		} 
		
	}
	
	// Added as the driver of the draw funcion
	function drawDriver(){
		if (feedFinished == 1) {
			draw();
		}
		else {
			drawDialog();
		}
	}
	
	
	function drawDialog() {

		// Set the origin of the canvas
		var origin = new Vector2();
		origin.set(skimmer.width/2, skimmer.height/2);
		
		// Fill the background
		ctx.fillStyle = 'rgba(0,0,0,1.0)';
		ctx.fillRect(0,0,canvas.width,canvas.height);
		
		// To scale the drawing result according to the screen
		scaleNow = 0;		// The scale for the rescaled screen
		scaleOld = 0;		// The scale for the 1024 * 768 screen
		if (canvas.width <= canvas.height) {
			scaleNow = canvas.width;
			scaleOld = 1024;
		}
		else {
			scaleNow = canvas.height;
			scaleOld = 768;
		}
		
		// Set the starting point and the size of the color key box
		var OffSet = 30;
		var DialogX = canvas.width * 1 / 3;
		var DialogY = canvas.height * 3 / 7;
		var DialogWidth  = canvas.width * 1 / 3;
		var DialogHeight = canvas.height * 1 / 7;


		// Draw the dialog out
		ctx.fillStyle = 'rgba(200, 200, 200, 0.5)';
		ctx.fillRect(DialogX, DialogY, DialogWidth, DialogHeight);
		
		
		// ADJECTIVE
		ctx.font = 'bold '+Math.round(30 * scaleNow / scaleOld)+'px Arial';
		ctx.textAlign = "left";
		ctx.textBaseline = "top";
		ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
		ctx.fillText("LOADING DATA...", DialogX + DialogWidth / 6, DialogY + DialogHeight / 2 - 30 / 2 * scaleNow / scaleOld);

		
		ctx.fillStyle = "#fff";
		ctx.textAlign = "center";
		ctx.textBaseline = "middle";
		ctx.fillText("Skimmer, by Design Graphics Lab", canvas.width / 2, canvas.height - 20 *scaleNow / scaleOld);  //bottom
		//alert(canvas.height);

	}
	
	function draw(){

		// Set the global attributes of the canvas
		// These lines of code should always be placed first
		var origin = new Vector2();
		
		origin.set(skimmer.width/2, skimmer.height/2);
		ctx.fillStyle = 'rgba(0,0,0,1.0)';
		ctx.fillRect(0,0,skimmer.width,skimmer.height);

		// To scale the drawing result according to the screen
		scaleNow = 0;		// The scale for the rescaled screen
		scaleOld = 0;		// The scale for the 1024 * 768 screen
		if (skimmer.width <= skimmer.height) {
			scaleNow = skimmer.width;
			scaleOld = 1024;
		}
		else {
			scaleNow = skimmer.height;
			scaleOld = 768;
		}


		//-----------------------------------------------------------------------------------------------
		// The code above is too messy to read, The function is to draw the elements on the canvas
		//-----------------------------------------------------------------------------------------------

		// The color key box of the canvas

		// Set the starting point and the size of the color key box
		var OffSet = 30;
		var ColorKeyStartX = skimmer.width - 180 * scaleNow / scaleOld - OffSet * scaleNow / scaleOld;
		var ColorKeyStartY = skimmer.height - 180 * scaleNow / scaleOld - OffSet * scaleNow / scaleOld;
		var ColorKeyWidth  = 180 * scaleNow / scaleOld;
		var ColorKeyHeight = 180 * scaleNow / scaleOld;

		// Set the border width of the color key box
		var Border = 4;


		// To confirm the existance of the skimmer object
		if (skimmer != undefined) {
			// Show the color key according to the color mapping scheme
			switch (skimmer.colorType) {
				case "0":
					// random
					// There is no color key for a random color mapping scheme
					/*
					// Draw the box and the border
					ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
					ctx.fillRect(ColorKeyStartX, ColorKeyStartY, ColorKeyWidth, ColorKeyHeight);
					ctx.fillStyle = 'rgba(150, 150, 150, 0.6)';
					ctx.fillRect(ColorKeyStartX + Border, ColorKeyStartY + Border, ColorKeyWidth - 2 * Border, ColorKeyHeight - 2 * Border);

					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "left";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
					ctx.fillText("RANDOM", ColorKeyStartX + Border + 3, ColorKeyStartY + ColorKeyHeight / 2 - 16 * scaleNow / scaleOld);
					 */
					break;
				case "1":
					// grammar
					// Draw the box and the border
					ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
					ctx.fillRect(ColorKeyStartX, ColorKeyStartY, ColorKeyWidth, ColorKeyHeight);
					ctx.fillStyle = 'rgba(150, 150, 150, 0.6)';
					ctx.fillRect(ColorKeyStartX + Border, ColorKeyStartY + Border, ColorKeyWidth - 2 * Border, ColorKeyHeight - 2 * Border);

					// ADJECTIVE
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(0, 0, 100, 1.0)';
					ctx.fillText("ADJECTIVE", ColorKeyStartX + ColorKeyWidth / 2, ColorKeyStartY + ColorKeyHeight * 1 / 6 - 8 * scaleNow / scaleOld);

					// VERB
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(0, 100, 0, 1.0)';
					ctx.fillText("VERB", ColorKeyStartX + ColorKeyWidth / 2, ColorKeyStartY + ColorKeyHeight * 2 / 6 - 8 * scaleNow / scaleOld);

					// ADVERB
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(100, 100, 0, 1.0)';
					ctx.fillText("ADVERB", ColorKeyStartX + ColorKeyWidth / 2, ColorKeyStartY + ColorKeyHeight * 3 / 6 - 8 * scaleNow / scaleOld);

					// INTERJECTION
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(100, 0, 0, 1.0)';
					ctx.fillText("INTERJECTION", ColorKeyStartX + ColorKeyWidth / 2, ColorKeyStartY + ColorKeyHeight * 4 / 6 - 8 * scaleNow / scaleOld);

					// NOUN
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(100, 0, 100, 1.0)';
					ctx.fillText("NOUN", ColorKeyStartX + ColorKeyWidth / 2, ColorKeyStartY + ColorKeyHeight * 5 / 6 - 8 * scaleNow / scaleOld);

					break;
				case "3":
					// emotioin
					// Draw the box and the border
					ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
					ctx.fillRect(ColorKeyStartX, ColorKeyStartY, ColorKeyWidth, ColorKeyHeight);
					ctx.fillStyle = 'rgba(150, 150, 150, 0.6)';
					ctx.fillRect(ColorKeyStartX + Border, ColorKeyStartY + Border, ColorKeyWidth - 2 * Border, ColorKeyHeight - 2 * Border);


					// Set the boundings of the gradient area
					var GradientOffset = 36 * scaleNow / scaleOld
					var GradientX = ColorKeyStartX + Border + GradientOffset / 2;
					var GradientY = ColorKeyStartY + Border + GradientOffset;
					var GradientWidth  = ColorKeyWidth - GradientOffset - 2 * Border;
					var GradientHeight = ColorKeyHeight - 2 * GradientOffset - 2 * Border;

					// Draw the gradient color key
					var colorkey_gradient = ctx.createLinearGradient(GradientX, GradientY, GradientX, GradientY + GradientHeight);
					colorkey_gradient.addColorStop(0, 'rgba(255, 255, 0, 0.5)');
					colorkey_gradient.addColorStop(1, 'rgba(0, 0, 255, 0.5)');
					ctx.fillStyle = colorkey_gradient;
					ctx.fillRect(GradientX, GradientY, GradientWidth, GradientHeight);

					// HAPPY
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(100, 100, 0, 1.0)';
					ctx.fillText("HAPPY", ColorKeyStartX + ColorKeyWidth / 2, ColorKeyStartY + 16 * scaleNow / scaleOld);

					// SAD
					ctx.font = 'bold '+Math.round(16 * scaleNow / scaleOld)+'px Arial';
					ctx.textAlign = "center";
					ctx.textBaseline = "top";
					ctx.fillStyle = 'rgba(0, 0, 100, 1.0)';
					ctx.fillText("SAD", ColorKeyStartX + ColorKeyWidth / 2 , ColorKeyStartY + ColorKeyHeight * 13 / 16);

					break;

				default: 
					break;
			}
		}
		////////////////////////////////////////////BOTTOM TITLE
		
		var skimmerTextWidth = ctx.measureText("Skimmer, by Design Graphics Lab").width;


		if( origin.x + skimmer.agentTitle.pos.x - skimmerTextWidth / 2.0 < currentCursor.x && currentCursor.x < origin.x + skimmer.agentTitle.pos.x + skimmerTextWidth / 2.0 )
		{

			if	( skimmer.height - 2*20 * scaleNow / scaleOld < currentCursor.y && currentCursor.y < skimmer.height - 20 * scaleNow / scaleOld )
			{
				//alert("oh");
				ctx.fillStyle = "#333";
				if(origin.x + skimmer.agentTitle.pos.x - skimmerTextWidth / 6.0 < currentCursor.x )
					linkFlag = 3;
				else
					linkFlag = 2;
			}
			else{linkFlag = 0;}
		}	
		else{linkFlag = 0;}

		ctx.fillStyle = "#fff";
		ctx.fillText("Skimmer, by Design Graphics Lab", origin.x + skimmer.agentTitle.pos.x, skimmer.height - 20 * scaleNow / scaleOld);  //bottom
		////////////////////////////////////////////
		
		
		var showImage = document.getElementsByName("showImage");
		if(showImage[0].checked == true)
			showImageFlag = 1;
		else
			showImageFlag = 0;


		// Draw the circles. //
		if( skimmer.DRAW_CIRCLES ) {

			if(depthOrder.length != 0 && depthOrder.length == skimmer.agents.length){
				if( depthChangeCount > 100000 ) depthChangeCount = 0 ;


				if( ++depthChangeCount%20 == 0 ){
					depthOrder.sort(function(a,b) {return a[1]-b[1]});
				}

				for(var i=0;i<depthOrder.length;i++){ depthOrder[i][1] = (depthOrder[i][1]+1)%DEPTHLAYER; }
			}



			for(var pi = 0; pi < skimmer.agents.length; pi++){
				if(depthOrder.length != 0 &&  depthOrder.length == skimmer.agents.length)
					i = depthOrder[pi][0];
				else
					i = pi;
					
				var agent = skimmer.agents[i];

				var alpha = parseFloat( 0.75 * ( parseFloat( agent.TICKS_TILL_FADE - agent.curTicksTillFade ) / agent.TICKS_TILL_FADE ) );
				if( alpha > 1.0 ) { alpha = 1.0; }
				if( alpha < 0.0 ) { alpha = 0.0; }
				skimmer.agents[i].shapeColor.alpha = alpha;
				ctx.fillStyle = agent.shapeColor.toString();
				if(skimmer.selectedWords.length != 0 && (skimmer.selectedWords.indexOf(agent) < 0 )){
					var colorUnselected = agent.shapeColor.darker();
					ctx.fillStyle = colorUnselected.toString();
				}

				var radius = parseInt(Math.round( ( skimmer.minRadius + ( agent.occurrences /  skimmer.maxOccurrence )
								* ( skimmer.minRadius ) ) * 2.0 * scaleNow / scaleOld));

				// updates the radius value
				skimmer.agents[i].radius = radius / 2;
				ctx.beginPath();
				ctx.arc(Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y),Math.round(radius / 2)-1, 0, Math.PI * 2, false); 
				ctx.fill();  
				ctx.closePath();  

				//ctx.save();
				//ctx.beginPath();
				//ctx.arc(Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y),Math.round(radius/2),0,Math.PI*2,true);
				//ctx.closePath();
				//ctx.clip();


				if (skimmer.agents[i].imageLinkList[0] !=null && skimmer.colorType == 0 && showImageFlag == 1 )	{
					var imgNews = new Image();
					try{
						if(skimmer.agents[i].imageFrequency>1000) skimmer.agents[i].imageFrequency=1;

						if(++skimmer.agents[i].imageFrequency%100 == 0 && Math.random() < 1 || skimmer.agents[i].switchPicture > 0){
							/*
							   if(skimmer.agents[i].imageFrequency>1000) skimmer.agents[i].imageFrequency=1;

							   if(skimmer.agents[i].imageFrequency++%150 == 0 && Math.random() < 0.5 || skimmer.agents[i].switchPicture > 0)
							   skimmer.agents[i].imageIndex = (skimmer.agents[i].imageIndex+1)%skimmer.agents[i].imageLinkList.length;

							   imgNews.src = skimmer.agents[i].imageLinkList[skimmer.agents[i].imageIndex];
							 */
							if(skimmer.agents[i].switchPicture == 0){

								imgNews.src = skimmer.agents[i].imageLinkList[skimmer.agents[i].imageIndex];

								if(skimmer.agents[i].validImageFlag == 1 && imgNews.width > LEAST_IMAGE_WIDTH )
								{
									skimmer.agents[i].validImageFlag = 0; 
									skimmer.agents[i].validImage = new Image();
									skimmer.agents[i].validImage.src = imgNews.src;
								}


								if ( imgNews.width > LEAST_IMAGE_WIDTH )
									//ctx.drawImage(imgNews,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,imgNews,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
								else if (skimmer.agents[i].validImageFlag == 0)
									//ctx.drawImage(skimmer.agents[i].validImage, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,skimmer.agents[i].validImage,agent.shapeColor, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

								skimmer.agents[i].switchPicture ++;
							}

							else if(skimmer.agents[i].switchPicture < 21 ){

								//ctx.fillStyle = "#000";
								//ctx.arc(Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y),Math.round(radius / 2), 0, Math.PI * 2, false); 


								var inc = (skimmer.agents[i].imageIndex+1)%skimmer.agents[i].imageLinkList.length;
								var fflag = 0;
								ctx.globalAlpha = 1 - skimmer.agents[i].switchPicture/ 20.0;
								imgNews.src = skimmer.agents[i].imageLinkList[skimmer.agents[i].imageIndex];

								if ( imgNews.width > LEAST_IMAGE_WIDTH )
									//ctx.drawImage(imgNews,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,imgNews,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

								else if (skimmer.agents[i].validImageFlag == 0){
									//ctx.drawImage(skimmer.agents[i].validImage, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,skimmer.agents[i].validImage, agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									fflag++;
								}

								ctx.globalAlpha = 1-ctx.globalAlpha;
								var newImg = new Image();
								newImg.src = skimmer.agents[i].imageLinkList[inc];


								if ( newImg.width > LEAST_IMAGE_WIDTH )
									//ctx.drawImage(newImg,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,newImg,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

								else if (skimmer.agents[i].validImageFlag == 0){
									//ctx.drawImage(skimmer.agents[i].validImage, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,skimmer.agents[i].validImage,agent.shapeColor, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

									fflag++;
								}

								skimmer.agents[i].switchPicture ++;
								ctx.globalAlpha = 1 ;

								if ( fflag == 2 )
									//ctx.drawImage(skimmer.agents[i].validImage, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,skimmer.agents[i].validImage,agent.shapeColor, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

								else if (newImg.src == imgNews.src)
									//ctx.drawImage(newImg, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,newImg,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);


								newImg=null;
							}
							else{
								skimmer.agents[i].switchPicture = 0 ;	
								skimmer.agents[i].imageIndex = (skimmer.agents[i].imageIndex+1)%skimmer.agents[i].imageLinkList.length;
								imgNews.src = skimmer.agents[i].imageLinkList[skimmer.agents[i].imageIndex];

								if ( imgNews.width > LEAST_IMAGE_WIDTH )
									//ctx.drawImage(imgNews,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,imgNews,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

								else if (skimmer.agents[i].validImageFlag == 0)
									//ctx.drawImage(skimmer.agents[i].validImage, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
									drawAvoidStretch(agent,ctx,skimmer.agents[i].validImage,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);


							}
						}

						else{

							//skimmer.agents[i].imageIndex = (skimmer.agents[i].imageIndex+1)%skimmer.agents[i].imageLinkList.length;
							imgNews.src = skimmer.agents[i].imageLinkList[skimmer.agents[i].imageIndex];
							if ( imgNews.width > LEAST_IMAGE_WIDTH )
								//ctx.drawImage(imgNews,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
								drawAvoidStretch(agent,ctx,imgNews,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

							else if (skimmer.agents[i].validImageFlag == 0)
								//ctx.drawImage(skimmer.agents[i].validImage, Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
								drawAvoidStretch(agent,ctx,skimmer.agents[i].validImage,agent.shapeColor,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);

						}


						if(imgNews.width > 0 || skimmer.agents[i].validImageFlag == 0 ){
							//ctx.drawImage(imgNews,Math.round(origin.x + agent.avgPos.x-radius / 2 ), Math.round(origin.y + agent.avgPos.y-radius / 2),radius,radius);
							skimmer.agents[i].imageLinkValidation = 1;
						}

						else
							skimmer.agents[i].imageLinkValidation = 0;


					}
					catch(e){
						skimmer.agents[i].imageLinkValidation = 0;
						console.log(imgNews.src);


					}
					imgNews=null;

				}
				//ctx.restore();
			}
		}

		// Draw outline boxes for selected agents. //
		for(var i = 0; i < skimmer.agents.length; i++){
			var agent = skimmer.agents[i];
			var alpha = parseFloat(parseFloat(agent.TICKS_TILL_FADE - agent.curTicksTillFade) / agent.TICKS_TILL_FADE);
			if( alpha > 1.0 ) { alpha = 1.0; }
			if( alpha < 0.0 ) { alpha = 0.0; }
			if(skimmer.selectedWords.indexOf(agent) > -1){
				ctx.fillStyle = agent.shapeColor.toString();
				var agentBounds = agent.getBoundingBox();
				
				ctx.save();
				ctx.beginPath();
				ctx.arc(Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y),Math.round(agent.radius)-1,0,Math.PI*2,true);
				ctx.closePath();
				ctx.clip();
				
				//ctx.fillRect(Math.round(origin.x + agent.avgPos.x - agentBounds.extents.x * scaleNow / scaleOld),
				//		Math.round(origin.y + agent.avgPos.y - agentBounds.extents.y* scaleNow / scaleOld),
				//		Math.round(agentBounds.extents.x * 2* scaleNow / scaleOld),
				//		Math.round(agentBounds.extents.y * 2* scaleNow / scaleOld));
				
				ctx.fillRect(Math.round(origin.x + agent.avgPos.x - agentBounds.extents.x),
						Math.round(origin.y + agent.avgPos.y - agentBounds.extents.y * scaleNow / scaleOld),
						Math.round(agentBounds.extents.x * 2),
						Math.round(agentBounds.extents.y * 2* scaleNow / scaleOld));
				
				ctx.restore();
			
			}
		}

		// Draw all of the text and set the agent's bounding box. //
		for(var i = 0; i < skimmer.agents.length; i++){
			var agent = skimmer.agents[i];
			var alpha = parseFloat( (  agent.TICKS_TILL_FADE - agent.curTicksTillFade ) / agent.TICKS_TILL_FADE ) ;
			if( alpha > 1.0 ) { alpha = 1.0; }
			if( alpha < 0.0 ) { alpha = 0.0; }
			ctx.fillStyle = agent.textColor.toString();
			ctx.textBaseline = 'middle';
			ctx.textAlign = 'center';
			/*
			if(skimmer.zoomedAgents.indexOf(agent) > -1){
				ctx.font = 'bold' + Math.round(16 * scaleNow / scaleOld) + 'px Arial';
			}
			else{
				ctx.font = 'bold ' + Math.round(16 * scaleNow / scaleOld) + 'px Arial';
			}
			*/
			
			if(agent.clickPriority == 1){
				ctx.font = 'bold ' + Math.round(16 * scaleNow / scaleOld) + 'px Arial';
			}
			else{
				ctx.font = 'italic bold ' + Math.round(16 * scaleNow / scaleOld) + 'px Arial';
			}
			
			metrics = ctx.measureText(agent.text);
			skimmer.agents[i].bounds.extents.set( metrics.width / 2.0 +5 , 10 );
			if(skimmer.selectedWords.length != 0 && (skimmer.selectedWords.indexOf(agent) < 0 )){
				var colorUnselected = agent.textColor.darker().darker();
				ctx.fillStyle = colorUnselected.toString();
			}		

			//back ground color

			if (agent.imageLinkList[0] !=null && skimmer.colorType == 0 && showImageFlag == 1 && agent.imageLinkValidation == 1 && skimmer.selectedWords.indexOf(agent) < 0 )	{

				ctx.save();
				ctx.beginPath();
				ctx.arc(Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y),Math.round(agent.radius)-1,0,Math.PI*2,true);
				ctx.closePath();
				ctx.clip();

				ctx.fillStyle = 'rgba(50,50,50,0.8)';
				var agentBounds = agent.getBoundingBox();
				ctx.fillRect(Math.round(origin.x + agent.avgPos.x - agentBounds.extents.x),
						Math.round(origin.y + agent.avgPos.y - agentBounds.extents.y * scaleNow / scaleOld),
						Math.round(agentBounds.extents.x * 2),
						Math.round(agentBounds.extents.y * 2* scaleNow / scaleOld));

				ctx.restore();	

			}


			ctx.fillStyle='rgba(250,250,250,0.8)';
			ctx.fillText(agent.text.toLowerCase(), Math.round(origin.x + agent.avgPos.x), Math.round(origin.y + agent.avgPos.y));

		}


		// Draw other user agent if it exists. //
		if( false ) {

			if( skimmer.DRAW_CIRCLES ) {
				ctx.fillStyle = 'rgba(255,255,255,0.8)';

				ctx.beginPath();
				ctx.arc(Math.round( origin.x + skimmer.agentUser.avgPos.x), Math.round( origin.y + skimmer.agentUser.avgPos.y), skimmer.agentUser.radius* scaleNow / scaleOld, 0, Math.PI * 2, false );

				ctx.fill();  
				ctx.closePath();
			}
		}

		// Draw the title agent if it exists. //
		if( skimmer.agentTitle != null ) {
			ctx.fillStyle = 'rgba(150,150,150,0.6)';
			ctx.textBaseline = 'middle';
			ctx.textAlign = 'center';
			ctx.font = 'bold ' + Math.round(30 * scaleNow / scaleOld) + 'px Arial';

			//gradientPaint
			ctx.beginPath();
			//ctx.fillRect(origin.x + skimmer.agentTitle.pos.x - (skimmer.agentTitle.text.length * 8 + 8) *  scaleNow / scaleOld, 0, (skimmer.agentTitle.text.length * 16 + 16) * scaleNow / scaleOld, 40 * scaleNow / scaleOld);
			ctx.fillStyle = 'rgba(255,255,255,255.8)';
			ctx.fillText(skimmer.agentTitle.text, origin.x + skimmer.agentTitle.pos.x, 20 * scaleNow / scaleOld); //top



		}

		if(skimmer.agentArticle != null){
			// Clip the title to fit within the assigned width
			var displayedTitle = "";
			ctx.font = 'bold '+Math.round(20* scaleNow / scaleOld)+'px Arial';

			var droppedChars = false;
			for(var i = 0; i < skimmer.agentArticle.title.length; i++){
				if(ctx.measureText(displayedTitle).width > skimmer.agentArticle.width * 0.75 ){
					droppedChars = true;
					break;
				}	
				displayedTitle += skimmer.agentArticle.title.charAt(i);
			}
			if(droppedChars){
				displayedTitle += "...";
			}

			ctx.font = 'bold '+Math.round(16* scaleNow / scaleOld)+'px Arial';
			var displayedSource = "";

			var droppedChars1 = false;
			for(var i = 0; i < skimmer.agentArticle.source.length; i++){
				if(ctx.measureText(displayedSource).width > skimmer.agentArticle.width * 0.75 ){
					droppedChars1 = true;
					break;
				}
				displayedSource += skimmer.agentArticle.source.charAt(i);
			}
			if(droppedChars1){
				displayedSource += "...";
			}

			// Reset Max Height to original height
			skimmer.agentArticle.height = skimmer.agentArticle.originalHeight;

			// Extract the lines from the body text and match vertical height to this property
			if(skimmer.agentArticle.text != ""){
				// Extract meaningful measurements and adjust vertical height if necessary

				var requiredTextHeight = 20;

				//deal with text
				var dealString = skimmer.agentArticle.text;
				var dealWords = dealString.split(" ");
				var dealedLines = new Array();
				var j = 0;
				dealedLines.push(new String(""));
				ctx.font = 'bold ' + Math.round(16*scaleNow / scaleOld)+'px Arial';
				dealedLines[0] += dealWords[0];
				var textWidth = 0;
				var lineWidth = 0;
				for(var i = 1; i < dealWords.length; i++){

					if(ctx.measureText(dealedLines[j] + " " + dealWords[i]).width <= (skimmer.agentArticle.width * 0.9 )){

						dealedLines[j] += " ";
						dealedLines[j] += dealWords[i];
					}
					else{
						if(ctx.measureText(dealedLines[j]).width > textWidth){
							textWidth = ctx.measureText(dealedLines[j]).width;
						}
						dealedLines.push(new String(""));
						j += 1;
						dealedLines[j] += dealWords[i];
					}
				}
				if(ctx.measureText(dealedLines[j]).width > textWidth){
					textWidth = ctx.measureText(dealedLines[j]).width;
				}

				// Font height
				requiredTextHeight += dealedLines.length * 15 *scaleNow / scaleOld;
				ctx.font = 'bold 20px Arial';
				var titleWidth = ctx.measureText(displayedTitle).width;
				var titleHeight = 24*scaleNow/scaleOld;

				ctx.font = 'bold 16px Arial';
				var sourceWidth = ctx.measureText(skimmer.agentArticle.source).width;
				var sourceHeight = 20*scaleNow/scaleOld;

				skimmer.agentArticle.height = requiredTextHeight + titleHeight + sourceHeight;
				var titleOffsetY = parseInt(Math.round(20 * 1.75));
				var sourceOffsetY;

				var textBackgroundHeight = skimmer.agentArticle.height - titleHeight - sourceHeight;
				//alert("titleHeight"+titleHeight+"sourceHeight"+sourceHeight+"skimmer.agentArticle.height"+skimmer.agentArticle.height);

				var titleOrigin = new Vector2();
				titleOrigin.set(origin.x + skimmer.agentArticle.pos.x - skimmer.agentArticle.width / 2.0,
						origin.y + skimmer.agentArticle.pos.y - skimmer.agentArticle.height / 2.0);
				var textOrigin = new Vector2();
				textOrigin.set(titleOrigin.x, titleOrigin.y + titleHeight);
				var sourceOrigin = new Vector2();
				sourceOrigin.set(textOrigin.x, textOrigin.y + textBackgroundHeight);

				ctx.lineWidth = "1";
				ctx.fillStyle = 'rgba(140,140,140,0.9)';
				ctx.strokeStyle = 'rgba(150,150,150,0.9)';


				ctx.fillRect(titleOrigin.x, titleOrigin.y, skimmer.agentArticle.width, titleHeight);
				ctx.strokeRect(titleOrigin.x, titleOrigin.y, skimmer.agentArticle.width, titleHeight);

				ctx.fillRect(sourceOrigin.x, sourceOrigin.y, skimmer.agentArticle.width, sourceHeight);
				ctx.strokeRect(sourceOrigin.x, sourceOrigin.y, skimmer.agentArticle.width, sourceHeight);

				ctx.strokeStyle = 'rgba(180,180,180,0.9)';
				ctx.strokeRect(textOrigin.x, textOrigin.y, skimmer.agentArticle.width, textBackgroundHeight);
				ctx.fillStyle = 'rgba(240,240,240,0.9)';
				ctx.fillRect(textOrigin.x, textOrigin.y, skimmer.agentArticle.width, textBackgroundHeight);

				////////////////////////////////////////////////////////////////////////////////////
				ctx.font = 'bold '+Math.round(16* scaleNow / scaleOld)+'px Arial';
				ctx.textAlign = "left";
				ctx.textBaseline = "top";
				ctx.fillStyle = 'rgba(50,50,50,0.9)';
				var lineOrigin = textOrigin.y + 10* scaleNow / scaleOld;
				for(var i = 0; i < dealedLines.length; i++){
					//ctx.fillText(dealedLines[i],textOrigin.x + (skimmer.agentArticle.width / 2.0 - textWidth / 2.0+5), lineOrigin);
					ctx.fillText(dealedLines[i],textOrigin.x + Math.round(skimmer.agentArticle.width * 0.05), lineOrigin);
					/*
					 * real content
					 * 
					 * */
					lineOrigin += 15* scaleNow / scaleOld;

				}

				ctx.font = 'bold '+Math.round(20* scaleNow / scaleOld)+'px Arial';
				ctx.fillText( displayedTitle, textOrigin.x + Math.round(skimmer.agentArticle.width * 0.05), titleOrigin.y );
				/*
				 * real title
				 * 
				 * */


				ctx.font = 'bold '+Math.round(16* scaleNow / scaleOld)+'px Arial';

				if( sourceOrigin.x < currentCursor.x && currentCursor.x < sourceOrigin.x + skimmer.agentArticle.width )
				{
					//alert("oh");
					if	( sourceOrigin.y < currentCursor.y && currentCursor.y < sourceOrigin.y + sourceHeight )
					{
						//alert("oh");
						ctx.fillStyle = "#33f";
						linkFlag = 1;
					}
					else{linkFlag = 0;}
				}	
				else{linkFlag = 0;}
				ctx.fillText( displayedSource, textOrigin.x + Math.round(skimmer.agentArticle.width * 0.05), sourceOrigin.y + 2 );

				/*
				 * real link
				 * 
				 * */

				skimmer.agentArticle.bounds.extents.set(skimmer.agentArticle.width / 2 + 10, skimmer.agentArticle.height / 2 + 10);
			}
			else{
				skimmer.agentArticle.remove = true;
				skimmer.selectedWords.length = 0;
				skimmer.selectedArticles.length = 0;
				skimmer.selectedArticleRanking.clear();
			}
		}
		
		for(var i = 0; i < skimmer.agents.length; i++){
	
			if(skimmer.agentArticle != null) break;
		
			if(skimmer.agents[i].clickPriority == 2 && skimmer.agents[i].removeCount > AGENT_REMOVE_LIMIT && Math.random() < 0.1 ){
				var curIndex = skimmer.agents.indexOf(skimmer.agents[i]);
				skimmer.agents[curIndex].remove = true;
			}
			else if(skimmer.agents[i].clickPriority == 2){
				skimmer.agents[i].removeCount++;
			}
		
		}
	
		skimmer.update(0.05, 1024.0, 768.0, scaleNow , scaleOld);

	}	

		
	
	// This function is used to get the canvas filling the screen when the size of the screen is changed
	
	// The function used to searching the internet and get the result from the Search API
	// The result here is got from the Google news because this website will provide me with RSS data source
	function AddNewData() {
		isFlickr = 0;
		
		// Reset the feeding flag
		feedFinished = 0;
		
		// Construct the news search address with the help of the google news api
		// THe Source address of the RSS source is kept untouched because when we are to update the RSS feed, there is no need for us to change the RSS source
		
		// Set the URL for the google feed API
		var feed = new google.feeds.Feed(sourceAddress);
		// Set the number of entries to be read from the RSS online
		feed.setNumEntries(numEntries);

		// downloads the feed specified in the constructor from Google's servers and calls the given callback when the download completes
		feed.load(function(result) {
			if (!result.error) {
				feedResult = result;
				
				skimmer.UpdateUsingRssSource(feedResult, 10);


				skimmer.addNewArticles();
				skimmer.extractArticleMinMax();
				skimmer.checkForAdjacencies();
				skimmer.updateAgentsAdd();
				skimmer.extractAgentMinMax();
				buildAgentLinkList();

			}

			feedFinished = 1;

		});

		google.setOnLoadCallback(initialize);
				
	}
	
	
	// Get the width of the windows
	function getWinWidth(){
		if(window.innerWidth) {
		winWidth=window.innerWidth;
	}
	else if((document.body)&&(document.body.clientWidth)) {
		winWidth=document.body.clientWidth;
	}
		return winWidth;
	}
	
	// Get the height of the windows
	function getWinHeight(){
		if(window.innerHeight) {
			winHeight=window.innerHeight;
		}
		else if((document.body)&&(document.body.clientHeight)) {
			winHeight=document.body.clientHeight;
		}
		return winHeight;
	}
	
	
	function init(){
		
		var winWidth = getWinWidth();
		var winHeight = getWinHeight();

		table = document.getElementById("overallFrame");
		table.width = winWidth*ratioCanvas;
		table.height = winHeight*ratioCanvas;

		//table.width = 7000;
		//table.height = 2000;

		tableSel = document.getElementById("selectFrame");
		tableSel.width = Math.round(table.width * 1.0 / 9);
		tableSel.height = table.height;
		
		canvas = document.getElementById("canvas");
		canvas.width = Math.round(table.width * 8.0 / 9);
		canvas.height = table.height;
		
		ctx = canvas.getContext("2d");
		
		// Get the style ratio of the elements on the webpage
		if (canvas.width <= canvas.height) {
			scaleNow = canvas.width;
			scaleOld = 1024;
		}
		else {
			scaleNow = canvas.height;
			scaleOld = 768;
		}
		
		
		// The ratio of the logo
		var heightRatioLogo = 1.0 / 4;
		// The ratio of text input
		var heightRatioText = 1.0 / 30;
		// The ratio of buttons
		var heightRatioButton = 1.0 / 20;
		// The ratio of font size
		var heightRatioFont = 1.0 / 40;
		
		
		// Adjust the blank between two sets of elements
		tableSel.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";
		
		// The logo of the project as well as the DGL
		//skimmerLogo = document.getElementById("skimmerLogo");
		//skimmerLogo.style.width = tableSel.height * heightRatioLogo + "px";
		
		//skimmerLogo = document.getElementById("DGLLogo");
		//skimmerLogo.style.width = tableSel.height * heightRatioLogo + "px";
		
		selectColor = document.getElementById("selectColor");
		selectColor.style.width = tableSel.width+"px";
		selectColor.style.height = Math.round(tableSel.height * heightRatioText)+"px";
		selectColor.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";
	
		
		chooseSource = document.getElementById("chooseSource");
		chooseSource.style.width = tableSel.width+"px";	
		chooseSource.style.height = Math.round(tableSel.height * heightRatioText)+"px";
		chooseSource.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";


		academicSearching = document.getElementById("skimmerSearching");
		academicSearching.style.width = tableSel.width+"px";	
		academicSearching.style.height = Math.round(tableSel.height * heightRatioButton)+"px";
		academicSearching.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";
			

		addData = document.getElementById("addData");
		addData.style.width = tableSel.width+"px";
		addData.style.height = Math.round(tableSel.height * heightRatioButton)+"px";
		addData.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";


		autoMode = document.getElementById("autoMode");
		autoMode.style.width = tableSel.width+"px";
		autoMode.style.height = Math.round(tableSel.height * heightRatioButton)+"px";
		autoMode.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";


		searchContent = document.getElementById("searchContent");
		searchContent.style.width = tableSel.width+"px";
		searchContent.style.height = Math.round(tableSel.height * heightRatioButton)+"px";
		searchContent.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";

		
		chooseEngine = document.getElementById("chooseEngine");
		chooseEngine.style.width = tableSel.width+"px";	
		chooseEngine.style.height = Math.round(tableSel.height * heightRatioText)+"px";
		chooseEngine.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";
		

		advancedSearching = document.getElementById("advancedSearching");
		advancedSearching.style.width = tableSel.width+"px";
		advancedSearching.style.height = Math.round(tableSel.height * heightRatioButton)+"px";
		advancedSearching.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";
		
		
		AdvancedSearchBtn = document.getElementById("AdvancedSearchBtn");
		AdvancedSearchBtn.style.width = tableSel.width+"px";
		AdvancedSearchBtn.style.height = Math.round(tableSel.height * heightRatioButton)+"px";
		AdvancedSearchBtn.style.fontSize = Math.round(tableSel.height * heightRatioFont) + "px";
		
		
	}

	// The function to be operated when the window is resized
	function resizeWindow() {
		init();
		if(skimmer != undefined ){
		skimmer.width = canvas.width;
		skimmer.height = canvas.height;
		if(skimmer.agentArticle!=null) {
			skimmer.agentArticle.width = skimmer.width / 3 * scaleNow / scaleOld;
			skimmer.agentArticle.height = skimmer.height / 3 * scaleNow / scaleOld;
		}
		
		absPosX = 0;
		absPosY = 0;
		
		tempElem = canvas;
		
		while (tempElem.offsetParent != null) {
			absPosX += tempElem.offsetLeft;
			absPosY += tempElem.offsetTop;
			tempElem = tempElem.offsetParent;
		}
		
		absPosX += tempElem.offsetLeft;
		absPosY += tempElem.offsetTop;
		
		skimmer.left = absPosX;
		skimmer.top = absPosY;
	}
	}

	// Select the color mapping schema
	function SelectColor(){
		var selectObj = document.getElementById("selectColor");
		var selectIndex=selectObj.selectedIndex;
		var selectVal = selectObj.options[selectIndex].value;

		skimmer.colorType = selectVal;
		skimmer.updateAgentColor();
	}
	
	// Search for the content in the skimmer
	function skimmerSearching() {

		var selectObj = document.getElementById("chooseSource");
		var selectIndex=selectObj.selectedIndex;
		var selectVal = selectObj.options[selectIndex].value;
		
		switch(selectVal) {
			case 'ncsu_lib_news':
				isFlickr = 0;
				sourceAddress = "http://feeds.feedburner.com/NCSULibrariesNews?format=xml";
				break;
			case 'ncsu_events':
				isFlickr = 0;
				sourceAddress = "http://calendar.activedatax.com/ncstate/RSSSyndicator.aspx?category=&location=&type=N&binary=Y&keywords=";
				break;
			case 'ncsu_twitter_search':
				isFlickr = 0;
				sourceAddress = "http://search.twitter.com/search.rss?q=%23ncsu";
				break;
			case 'ncsu_twitter_account':
				isFlickr = 0;
				sourceAddress = "http://twitter.ncsu.edu/feed.php";
				break;	
			case 'ncsu_facebook':
				isFlickr = 0;
				sourceAddress = "http://www.facebook.com/feeds/page.php?format=rss20&id=5983837179";
				break;
			case "google_news":
				isFlickr = 0;
				sourceAddress = "http://news.google.com/news?hl=en&gl=us&q=ncsu&num=100&um=1&ie=UTF-8&output=rss";
				break;
			case "flickr_tags":
				isFlickr = 1;
				sourceAddress = "http://api.flickr.com/services/feeds/photos_public.gne?tags=ncsu&lang=en-us&format=rss_200";
				break;
			case "lib_3_m_new":
				isFlickr = 0;
				sourceAddress = "http://catalog.lib.ncsu.edu/?service=search&N=206471&output=rss";
				break;
			case "lib_1_m_new":
				isFlickr = 0;
				sourceAddress = "http://catalog.lib.ncsu.edu/?service=search&N=206470&output=rss";
				break;
			case "lib_1_w_new":
				isFlickr = 0;
				sourceAddress = "http://catalog.lib.ncsu.edu/?service=search&N=206469&output=rss";
				break;
			default:
				break;
		}
		
		
		//------------------------------------------- Get the content from the Google Feed Api ----------------------------------------
		
		// Reset the feeding flag
		feedFinished = 0;
		
		// Set the URL for the google feed API
		var feed = new google.feeds.Feed(sourceAddress);
		// Set the number of entries to be read from the RSS online
		//feed.setNumEntries(numEntries);
		feed.setNumEntries(100);

		// downloads the feed specified in the constructor from Google's servers and calls the given callback when the download completes
		feed.load(function(result) {
			if (!result.error) {
				feedResult = result;

				numEntries = feedResult.feed.entries.length;
				if (numEntries > 0) {
					skimmer.UpdateSkimmer(feedResult, numEntries);
					skimmer.addNewArticles();
					skimmer.extractArticleMinMax();
					skimmer.checkForAdjacencies();
					skimmer.updateAgents();
					skimmer.extractAgentMinMax();
					buildAgentLinkList();
					
					var selectObj = document.getElementById("selectColor");
					var selectIndex=selectObj.selectedIndex;
					var selectVal = selectObj.options[selectIndex].value;

					skimmer.colorType = selectVal;
					skimmer.updateAgentColor();
				}
				else {
					alert("MORE SEARCHING RESULTS ARE NEEDED FOR VISUALIZATION");
				}
			}
			
			feedFinished = 1;

		});

		google.setOnLoadCallback(initialize);
				
	
	}
	
	
	
	
	//------------------------------- Advanced Searching --------------------------------
	
	
	// Search for the content in the skimmer
	function AdvancedSearching() {

		// Choose the searching engine from the list
		var selectObj = document.getElementById("chooseEngine");
		var selectIndex=selectObj.selectedIndex;
		var selectVal = selectObj.options[selectIndex].value;

		// Choose the search keyword of the advanced searching mode
		var inputObj = document.getElementById("searchContent");
		var inputVal = inputObj.value;
		
		switch(selectVal) {
			case 'ncsu_twitter_search':
				isFlickr = 0;
				sourceAddress = "http://search.twitter.com/search.rss?q=" + inputVal + "%23ncsu";
				break;
			case "google_news":
				isFlickr = 0;
				sourceAddress = "http://news.google.com/news?hl=en&gl=us&q=" + inputVal + "&num=100&um=1&ie=UTF-8&output=rss";
				break;
			case "flickr_tags":
				isFlickr = 1;
				sourceAddress = "http://api.flickr.com/services/feeds/photos_public.gne?tags=" + inputVal + "&lang=en-us&format=rss_200";
				break;
			case "lib_search":
				isFlickr = 0;
				sourceAddress = "http://catalog.lib.ncsu.edu/?Nty=1&Ntk=Keyword&service=search&N=0&output=rss&Ntt=" + inputVal;
				break;
			default:
				break;
		}
	
	
		//------------------------------------------- Get the content from the Google Feed Api ----------------------------------------
		
		// Reset the feeding flag
		feedFinished = 0;
		
		// Set the URL for the google feed API
		var feed = new google.feeds.Feed(sourceAddress);
		// Set the number of entries to be read from the RSS online
		//feed.setNumEntries(numEntries);
		feed.setNumEntries(100);

		// downloads the feed specified in the constructor from Google's servers and calls the given callback when the download completes
		feed.load(function(result) {
			if (!result.error) {
				feedResult = result;

				numEntries = feedResult.feed.entries.length;
				if (numEntries > 0) {
					skimmer.UpdateSkimmer(feedResult, numEntries);
					skimmer.addNewArticles();
					skimmer.extractArticleMinMax();
					skimmer.checkForAdjacencies();
					skimmer.updateAgents();
					skimmer.extractAgentMinMax();
					buildAgentLinkList();
					
					var selectObj = document.getElementById("selectColor");
					var selectIndex=selectObj.selectedIndex;
					var selectVal = selectObj.options[selectIndex].value;

					skimmer.colorType = selectVal;
					skimmer.updateAgentColor();
				}
				else {
					alert("MORE SEARCHING RESULTS ARE NEEDED FOR VISUALIZATION");
				}
			}

			feedFinished = 1;

		});

		google.setOnLoadCallback(initialize);
				
		
	}
	
	
	
	
	// The driver of he advanced searching mode
	var advancedFlag = 0;
	function AdvancedSearchDriver() {
	
		if (advancedFlag == 0) {
			AdvancedSearchBtn = document.getElementById("AdvancedSearchBtn");
			AdvancedSearchBtn.textContent = "Advanced";
		
			basicModeTbl = document.getElementById("advancedMode");
			basicModeTbl.hidden = true;
			
			advancedFlag = 1;
		}
		else {
			AdvancedSearchBtn = document.getElementById("AdvancedSearchBtn");
			AdvancedSearchBtn.textContent = "Basic";
		
			advancedModeTbl = document.getElementById("advancedMode");
			advancedModeTbl.hidden = false;
			
			advancedFlag = 0;
		}
		
	}

	
	
	//-----------------------------------------------------------------------------------------------------------	
	//---------------------------------------------- Automatical Mode -------------------------------------	
	//-----------------------------------------------------------------------------------------------------------	
	
	
	// variables setting the function intervals
	var autoIntervalID;
	var autoFlag = 0;
	var timeInterval = 30000;		// the time interval is set 0 minute 30 seconds
	
	var sourceSelectOrder = 0;
	
	var sourceXmlDoc;
	var sourceNodes;
	
	
	// The function used for the automated mode
	function autoModeFunc()
	{


		// Get the source address from the xml file

		websiteNodes = sourceNodes[sourceSelectOrder].getElementsByTagName("website");
		if (websiteNodes[0] != undefined) {
			website = websiteNodes[0].childNodes[0].nodeValue;
			
			var keywordVal = "";
					
			keywordNodes = sourceNodes[sourceSelectOrder].getElementsByTagName("keyword");
			if (keywordNodes[0] != undefined) {
				keywordVal = keywordNodes[0].childNodes[0].nodeValue;
			}

			
			switch (website) {
				case 'ncsu_twitter':
					isFlickr = 0;
					sourceAddress = "http://search.twitter.com/search.rss?q=" + keywordVal + "%23ncsu";
					break;
				case "google_news":
					isFlickr = 0;
					sourceAddress = "http://news.google.com/news?hl=en&gl=us&q=" + keywordVal + "&num=100&um=1&ie=UTF-8&output=rss";
					break;
				case "flickr":
					isFlickr = 1;
					sourceAddress = "http://api.flickr.com/services/feeds/photos_public.gne?tags=" + keywordVal + "&lang=en-us&format=rss_200";
					break;
			}

		}
		else {
			// Read URL directly from the xml file
			feedNodes = sourceNodes[sourceSelectOrder].getElementsByTagName("feed");
			if (feedNodes[0] != undefined) {
				sourceAddress = feedNodes[0].childNodes[0].nodeValue;
			}
		}

		//sourceAddress = sourceNodes[sourceSelectOrder].childNodes[0].nodeValue;
	
	
	
	
		//------------------------------------------- Get the content from the Google Feed Api ----------------------------------------

		// Reset the feeding flag
		feedFinished = 0;
		
		// Set the URL for the google feed API
		var feed = new google.feeds.Feed(sourceAddress);
		// Set the number of entries to be read from the RSS online
		feed.setNumEntries(100);

		// downloads the feed specified in the constructor from Google's servers and calls the given callback when the download completes
		feed.load(function(result) {
			if (!result.error) {
				feedResult = result;
				numEntries = feedResult.feed.entries.length;
				
				if (numEntries > 0) {
					skimmer.UpdateSkimmer(feedResult, numEntries);
					skimmer.addNewArticles();
					skimmer.extractArticleMinMax();
					skimmer.checkForAdjacencies();
					skimmer.updateAgents();
					skimmer.extractAgentMinMax();
					buildAgentLinkList();
				

					colorscheme = 0;
					colorNodes = sourceNodes[sourceSelectOrder].getElementsByTagName("color");
					if (colorNodes[0] != undefined) {
						colortag = colorNodes[0].childNodes[0].nodeValue;
						
						switch (colortag) {
							case 'random':
								colorscheme = 0;
								break;
							case 'dictionary':
								colorscheme = 1;
								break;
							case 'emotion':
								colorscheme = 3;
								break;
							default: 
								colorscheme = 0;
								break;
						}

					}


					skimmer.colorType = colorscheme;
					skimmer.updateAgentColor();
				}
				else {
					alert("MORE SEARCHING RESULTS ARE NEEDED FOR VISUALIZATION");
				}
			}

			feedFinished = 1;

		});

		google.setOnLoadCallback(initialize);

		// circulate the source address
		if (sourceSelectOrder >= sourceNodes.length - 1) {
			sourceSelectOrder = 0
		}
		else {
			sourceSelectOrder = sourceSelectOrder + 1;
		}

	}
	
	// Start or end the auto mode in skimmer
	function autoModeDriver()
	{
		if (autoFlag == 0) {
			// Reading xml file from disk
			sourceXmlDoc = loadXmlFile("data/sourceconfig.xml");
			sourceNodes = sourceXmlDoc.getElementsByTagName("source");

			autoIntervalID = setInterval(autoModeFunc, timeInterval);
			autoFlag = 1;

			autoMode = document.getElementById("autoMode");
			autoMode.textContent = "Manual";

			// Hide the basic manual mode
			AdvancedSearchBtn = document.getElementById("AdvancedSearchBtn");
			AdvancedSearchBtn.textContent = "Advanced";

			basicModeTbl = document.getElementById("basicMode");
			basicModeTbl.hidden = true;
			
			basicModeTbl = document.getElementById("advancedMode");
			basicModeTbl.hidden = true;
			
			advancedFlag = 1;


		}
		else{
			clearInterval(autoIntervalID);
			autoFlag = 0;

			autoMode = document.getElementById("autoMode");
			autoMode.textContent = "AutoMode";

			// Show the basic manual mode
			basicModeTbl = document.getElementById("basicMode");
			basicModeTbl.hidden = false;

		}
	}
	

	
</script>

</head>
<body onload = "init();" style="overflow:hidden" onmousedown="mouseClick(event);" onmousemove="mouseMove(event);" onresize="resizeWindow()" bgcolor="black">
<table id = "overallFrame" border = "0" cellpadding = "0" cellspacing = "0" bgcolor="black">
	<tr>
		<td>
			<table id = "selectFrame" border = "0" cellpadding = "0">
		
				
				
				<tr>
					<td>
					
						<table id = "basicMode" border = "0" cellpadding = "0">

							<!-- Basic manual mode-->
							<tr>
								<td>
									<font color = "white" face = "Arial">Color</font>
								</td>
							</tr>
							<tr>
								<td>
									<select id="selectColor" onChange = SelectColor()>
										<option value = 0>Random</option>
										<option value = 1>Dictionary</option>
										<option value = 3>Emotion</option>
									</select>
								</td>
							</tr>
							<tr>
								<td>
									<font color = "white" face = "Arial">Source</font>
								</td>
							</tr>
							
							<!-- This is used for the basic interactive mode -->
							<!-- This selection box select the source of the data from a given list of xml feeds -->
							<tr>
								<td>
									<select id="chooseSource" name="chooseSource">
										<option value = "ncsu_events">NCSU Events</option>
										<option value = "ncsu_lib_news">NCSU Library News</option>
										<option value = "ncsu_twitter_search">Twitter #NCSU</option>
										<option value = "ncsu_twitter_account">NC State Tweets</option>
										<option value = "ncsu_facebook">NCSU Facebook Wall</option>
										<option value = "google_news">NCSU - Google News</option>
										<option value = "flickr_tags">Flickr NCSU Tag</option>
										<option value = "lib_3_m_new">New in Last 3 Months</option>
										<option value = "lib_1_m_new">New in Last Month</option>
										<option value = "lib_1_w_new">New in Last Week</option>
									</select>
								</td>
							</tr>
							<tr>
								<td>
									<font color = "white" face = "Arial">Picture</font>
								</td>
							</tr>
							<tr>
								<td>
									<input type="radio" id="radio1" name="showImage" value="1" checked="true"> <font color = "white" face = "Arial">Yes</font>
									<input type="radio" id="radio2" name="showImage" value="2"> <font color = "white" face = "Arial">No</font>
								</td>
							</tr>
							<tr>
								<td>
									<button type = "button" name = "skimmerSearching" id = "skimmerSearching" onclick = skimmerSearching()>Search</button>
								</td>
							</tr>
							<tr>
								<td>
									<button type = "button" name = "AdvancedSearchBtn" id = "AdvancedSearchBtn" onclick = AdvancedSearchDriver()>Advanced</button>
								</td>
							</tr>	
												
						</table>
					
					</td>

				</tr>


				<tr>
					<td>
						<table id = "advancedMode" border = "0" cellpadding = "0">
				
							<!-- These are used as the Advanced interactive mode -->

							<tr>
								<td>
									<font color = "white" face = "Arial">Search Engine</font>
								</td>
							</tr>
							<!-- This selection box select the source of the search engines from a given list of xml feeds -->
							<tr>
								<td>
									<select id="chooseEngine" name="chooseEngine">
										<option value = "ncsu_twitter_search">twitter search</option>
										<option value = "google_news">Google News</option>
										<option value = "flickr_tags">Flickr Images</option>
										<option value = "lib_search">Library Search</option>
									</select>
								</td>
							</tr>
							<tr>
								<td>
									<font color = "white" face = "Arial">Keyword</font>
								</td>
							</tr>
							<tr>
								<td>
									<input type = "text" id = "searchContent" name = "searchContent"/>
								</td>
							</tr>
							<tr>
								<td>
									<button type = "button" name = "advancedSearching" id = "advancedSearching" onclick = "AdvancedSearching();">AdvancedSearch</button>
								</td>
							</tr>
							<tr>
								<td>
									<button type = "button" name = "addData" id = "addData" onclick = "AddNewData();">Refresh</button>
								</td>
							</tr>

						</table>
					</td>
				</tr>


				<!-- This button is used for switching between the manual mode and the automated mode -->
				<tr>
					<td>
						<button type = "button" name = "autoMode" id = "autoMode" onclick = "autoModeDriver();">AutoMode</button>
					</td>
				</tr>
				
				

				
				
				
				
			</table>
		</td>


		<td>
			<canvas id = "canvas"></canvas>
		</td>
		
	</tr>
</table>

<script type="text/javascript">

	// Initially set basic manual mode
	AdvancedSearchDriver();
	// Initially set automated mode
	//autoModeDriver();
	

	// Set the time interval for mouse move checking
	var mouseMoveCheckingTimeInterval = 1000;

	mouseMoveIntervalID = setInterval(checkMouseMove, mouseMoveCheckingTimeInterval);

	//intervalID = setInterval(draw, 25);
	intervalID = setInterval(drawDriver, 25);

	
	
	// Set the time interval for auto refreshing
	var autoRefreshingTimeInterval = 500000;
	
	// Set the refresh rate
	setInterval(AddNewData, autoRefreshingTimeInterval);
</script>
</body>
</html>